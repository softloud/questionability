---
title: "Validating the Graph Construction"
format: html
---

```{r}
set.seed(45)
```

> Generated by Copilot.

This document validates that the final graph correctly represents the simulated analyses.

## Setup

```{r}
#| label: setup
#| message: false

library(targets)
library(dplyr)
library(tidyr)
library(tidygraph)

project_root <- here::here()

for (f in list.files(file.path(project_root, "R"), full.names = TRUE, pattern = "\\.R$")) {
  source(f)
}

tar_load(simulated_analyses, store = file.path(project_root, "_targets"))
tar_load(column_index, store = file.path(project_root, "_targets"))
tar_load(graph, store = file.path(project_root, "_targets"))
```

## The Approach

Pick one analysis from the simulation. Check that the final graph contains:

1. The outcome node
2. All source column nodes used
3. All source → outcome edges
4. All source → source edges (pairwise co-occurrence)

## A Single Analysis

```{r}
#| label: single-analysis

single_analysis <- simulated_analyses |> sample_n(1)
single_analysis
```

This analysis used **`r single_analysis$outcome_type`** as the outcome with **`r length(single_analysis$source_cols[[1]])`** source columns:

```{r}
#| label: source-cols

column_index |>
  filter(col_index %in% single_analysis$source_cols[[1]])
```

## Expected Structure

With $n = `r length(single_analysis$source_cols[[1]])`$ source columns:

- 1 outcome node + $n$ source nodes
- $n$ source → outcome edges
- $\binom{n}{2} = `r choose(length(single_analysis$source_cols[[1]]), 2)`$ source → source edges

## Validation

```{r}
#| label: validate

result <- validate_analysis_in_graph(single_analysis, graph, column_index)

tibble(
  check = names(result$checks),
  passed = unlist(result$checks)
)
```

```{r}
#| label: summary

cat("All checks passed:", result$all_passed, "\n")
```

## Why This Works

If one randomly chosen analysis is correctly represented in the final graph, the aggregation logic is sound. The graph accumulates `n_analyses` counts across all analyses, but each individual analysis should contribute its nodes and edges.
